<!DOCTYPE html PUBLIC '-//W3C//DTD HTML 4.01//EN' 'http://www.w3.org/TR/html4/strict.dtd'>
<html>

<head>
  <title>ESP8266 Lamp Home</title>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
  <meta http-equiv='Content-Style-Type' content='text/css'/>
  <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=no'/>
  <link rel='shortcut icon' type='image/png' href='favicon.ico'/>
  <link rel='stylesheet' type='text/css' href='ggStyleSheet.css'/>
  <script language='javascript' type='text/javascript'>

    var mWebSocket = null;
    var mWebSocketServer = window.location.hostname;
    var mWebSocketReConnectTimerID = 0;

    function InitAll() {
      InitHtmlElements();
      InitWebSocket();
    }
  
    function InitWebSocket() {
      if (mWebSocketServer == '') {
        mWebSocketServer = window.prompt('Please enter address of WebSocket server', "192.168.0.54");
      }
      mWebSocket = new WebSocket('ws://' + mWebSocketServer +':81/', ['arduino']);
      mWebSocket.onopen = onWebSocketOpen;
      mWebSocket.onclose = onWebSocketClose;
      mWebSocket.onerror = onWebSocketError;
      mWebSocket.onmessage = onWebSocketMessage;
    }

    function onWebSocketOpen(aEvent) {
      mWebSocketStatus.innerHTML = 'connected';
      if (mWebSocketReConnectTimerID) {
        window.clearInterval(mWebSocketReConnectTimerID);
        mWebSocketReConnectTimerID = 0;
      }
    }

    function onWebSocketClose(aEvent) {
      mWebSocketStatus.innerHTML = 'disconnected';
      if (!mWebSocketReConnectTimerID) {
        mWebSocketReConnectTimerID = window.setInterval(InitWebSocket, 5000);
      }
    }

    function onWebSocketError(aEvent) {
      mWebSocketStatus.innerHTML = aEvent.data;
    }

    function onWebSocketMessage(aEvent) {
      try {
        // server sends actual function names, which can directly be executed by the client
        eval(aEvent.data);
      }
      catch (vError) {
        console.log('unable to evaluate: ' + aEvent.data);
      }
    }

    function WebSocketSendSetRingColorHSV() {
      mWebSocket.send('SetRingColorHSV('
        + mRingColorRangeH.value + ','
        + mRingColorRangeS.value + ','
        + mRingColorRangeV.value + ')');
    }

    function InitHtmlElements() {
      mName.onchange = function() {
        mWebSocket.send('SetName(' + mName.value + ')');
      }
      mOn.onchange = function() {
        mWebSocket.send('SetOn(' + mOn.checked + ')');
      }
      mCenterBrightnessRange.onchange = function() {
        mWebSocket.send('SetCenterBrightness(' + mCenterBrightnessRange.value + ')');
      }
      mRingColorRangeH.onchange = function() {
        WebSocketSendSetRingColorHSV();
      }
      mRingColorRangeS.onchange = function() {
        WebSocketSendSetRingColorHSV();
      }
      mRingColorRangeV.onchange = function() {
        WebSocketSendSetRingColorHSV();
      }
    }

    function ToHex(aValue) {
      var vHex = Number(aValue).toString(16);
      if (vHex.length < 2) vHex = '0' + vHex;
      return vHex;
    }    

    function HSVtoRGB(aH, aS, aV) {
      var vR = vG = vB = aV;
      if (aS != 0) {
        aH /= 42.501; // scale to 0..6
        aS /= 255; // scale to 0..1
        aV /= 255; // scale to 0..1
        var vI = Math.floor(aH); // interval (region)
        var vF = aH - vI; // factorial part of h
        var vP = aV * (1 - aS           );
        var vQ = aV * (1 - aS * (    vF));
        var vT = aV * (1 - aS * (1 - vF));
        switch (vI) {
          case 0:  vR = aV; vG = vT; vB = vP; break;
          case 1:  vR = vQ; vG = aV; vB = vP; break;
          case 2:  vR = vP; vG = aV; vB = vT; break;
          case 3:  vR = vP; vG = vQ; vB = aV; break;
          case 4:  vR = vT; vG = vP; vB = aV; break;
          default: vR = aV; vG = vP; vB = vQ; break; // case 5 or 6
        }
        vR = Math.round(255 * vR);
        vG = Math.round(255 * vG);
        vB = Math.round(255 * vB);
      }
      return '#' + ToHex(vR) + ToHex(vG) + ToHex(vB);
    }

    function UpdateName(aName) {
      mName.value = aName;
    }

    function UpdateOn(aOn) {
      mOnValue.innerHTML = aOn ? 'On' : 'Off';
      mOn.checked = aOn;
      mCenterBrightnessRange.disabled = !aOn;
      mRingColorRangeH.disabled = !aOn;
      mRingColorRangeS.disabled = !aOn;
      mRingColorRangeV.disabled = !aOn;
    }

    function UpdateCenterBrightness(aBrightness) {
      mCenterBrightnessValue.innerHTML = Math.round(100.0 * aBrightness) + '%';
      mCenterBrightnessRange.value = aBrightness;
      mCenterBrightnessRange.style.backgroundImage = 'linear-gradient(to right, #000 05%, #f90 95%)';
    }

    function UpdateRingColorHSV(aH, aS, aV) {
      mRingColorValueHSV.innerHTML = aH + '/' + aS + '/' + aV;
      mRingColorRangeH.value = aH;
      mRingColorRangeS.value = aS;
      mRingColorRangeV.value = aV;
      mRingColorRangeH.style.backgroundImage = 'linear-gradient(to right, '
        + HSVtoRGB(  0.0,aS,aV) + ' 5%, '
        + HSVtoRGB( 43.5,aS,aV) + ', '
        + HSVtoRGB( 85.0,aS,aV) + ', '
        + HSVtoRGB(127.5,aS,aV) + ', '
        + HSVtoRGB(170.0,aS,aV) + ', '
        + HSVtoRGB(221.5,aS,aV) + ', '
        + HSVtoRGB(255.0,aS,aV) + ' 95%)';
      mRingColorRangeS.style.backgroundImage = 'linear-gradient(to right, '
        + HSVtoRGB(aH,0,aV) + ' 5%, '
        + HSVtoRGB(aH,255,aV) + ' 95%)';
      mRingColorRangeV.style.backgroundImage = 'linear-gradient(to right, '
        + HSVtoRGB(aH,aS,0) + ' 5%, '
        + HSVtoRGB(aH,aS,255) + ' 95%)';
    }

  </script>
</head>

<body onload='javascript:InitAll()'>
  <div class='cMainBlockDiv'>

    <style>
      #mName { width: 97.5%; margin-top: 10px; margin-bottom: 10px; }
    </style>  
    <input id='mName' type='text' value='(na)' style='width:100%' class='cRoundedCentered' maxlength='30'>

    <style>
      .cTitleDiv { text-align: center; }
    </style>

    <div class='cTitleDiv'>Power: <span id='mOnValue'>(na)</span></div>
    <label class='switch'><input id='mOn' type='checkbox'><span class='switch_slider round'></span></label><br>

    <br>

    <div class='cTitleDiv'>Center Brightness: <span id='mCenterBrightnessValue'>(na)</span></div>
    <input id='mCenterBrightnessRange' type='range' min='0' max='1' step='0.01' value='0' class='range_slider' disabled><br>

    <br>

    <div class='cTitleDiv'>Ring Color: <span id='mRingColorValueHSV'>(na)</span></div>
    <input id='mRingColorRangeH' type='range' min='0' max='255' step='1' value='0' class='range_slider' disabled><br>
    <input id='mRingColorRangeS' type='range' min='0' max='255' step='1' value='0' class='range_slider' disabled><br>
    <input id='mRingColorRangeV' type='range' min='0' max='255' step='1' value='0' class='range_slider' disabled><br>

    <br>
    <hr noshade>

    Web Socket Status: <span id='mWebSocketStatus'>(na)</span><br>
    <hr noshade>
    <a href='/'>[home]</a>
    <a href='/files'>[files]</a>
    <a href='/debug'>[debug]</a>
    <br>
    (c) 2020, <a href='http://www.laimer.ch' target='_blank'>Christoph Laimer</a>

  </div>
</body>

</html>