﻿<!DOCTYPE html PUBLIC '-//W3C//DTD HTML 4.01//EN' 'http://www.w3.org/TR/html4/strict.dtd'>
<html>

<head>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
  <meta http-equiv='Content-Style-Type' content='text/css'>
  <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=no'/>
  <title>ESP8266 Thermostate</title>
  <link rel='shortcut icon' type='image/png' href='favicon.ico'/>
  <link rel='stylesheet' type='text/css' href='ggStyleSheet.css'>
  <script language='javascript' type='text/javascript'>

    var mWebSocket;
    var mWebSocketReConnectTimerID = 0;

    function initAll() {
      initHtmlElements();
      initWebSocket();
    }
  
    function initWebSocket() {
      // init web socket client
      mWebSocket = new WebSocket('ws://' + window.location.hostname + ':81/', ['arduino']);
      mWebSocket.onopen = onWebSocketOpen;
      mWebSocket.onclose = onWebSocketClose;
      mWebSocket.onerror = onWebSocketError;
      mWebSocket.onmessage = onWebSocketMessage;
    }

    function onWebSocketOpen(aEvent) {
      console.log(aEvent.data);
      mWebSocketStatus.innerHTML = 'connected';
      if (mWebSocketReConnectTimerID) {
        window.clearInterval(mWebSocketReConnectTimerID);
        mWebSocketReConnectTimerID = 0;
      }
    }

    function onWebSocketClose(aEvent) {
      console.log(aEvent.data);
      mWebSocketStatus.innerHTML = 'disconnected';
      if (!mWebSocketReConnectTimerID) {
        mWebSocketReConnectTimerID = window.setInterval(initWebSocket, 5000);
      }
    }

    function onWebSocketError(aEvent) {
      mWebSocketStatus.innerHTML = aEvent.data;
    }

    function onWebSocketMessage(aEvent) {
      // server sends actual function names, which can directly be executed by the client
      eval(aEvent.data);
    }

    var tControlMode = {
      eOff : 0,
      eOnBelow : 1,
      eOnAbove : 2,
      eOn : 3
    };
  
    function initHtmlElements() {
      mName.onchange = function() {
        mWebSocket.send('SetName(' + mName.value + ')');
      }
      mControlModeOff.onchange = function() {
        mWebSocket.send('SetControlMode(' + tControlMode.eOff + ')');
      }
      mControlModeOnBelow.onchange = function() {
        mWebSocket.send('SetControlMode(' + tControlMode.eOnBelow + ')');
      }
      mControlModeOnAbove.onchange = function() {
        mWebSocket.send('SetControlMode(' + tControlMode.eOnAbove + ')');
      }
      mControlModeOn.onchange = function() {
        mWebSocket.send('SetControlMode(' + tControlMode.eOn + ')');
      }
      mTemperatureRef.onchange = function() {
        mWebSocket.send('SetTemperatureRef(' + mTemperatureRef.value + ')');
      }
      mHysteresis.onchange = function() {
        mWebSocket.send('SetHysteresis(' + mHysteresis.value + ')');
      }
      mOutputAnalog.onchange = function() {
        mWebSocket.send('SetOutputAnalog(' + mOutputAnalog.checked + ')');
      }
      mOutputRange.onchange = function() {
        mWebSocket.send('SetOutput(' + mOutputRange.value + ')');
      }
    }
    
    function UpdateName(aName) {
      mName.value = aName;
    }

    function UpdateSensorStatus(aSensorStatus) {
      mSensorStatus.innerHTML = aSensorStatus;
    }

    function UpdatePressure(aPressure) {
      mPressure.innerHTML = aPressure + ' hPa';
    }

    function UpdateTemperature(aTemperature) {
      mTemperature.innerHTML = aTemperature + ' °C';
    }

    function UpdateHumidity(aHumidity) {
      mHumidity.innerHTML = aHumidity + ' %'
    }

    function UpdateControlMode(aControlMode) {
      switch (aControlMode) {
        case tControlMode.eOff: mControlModeOff.checked = true; break;
        case tControlMode.eOnBelow: mControlModeOnBelow.checked = true; break;
        case tControlMode.eOnAbove: mControlModeOnAbove.checked = true; break;
        case tControlMode.eOn: mControlModeOn.checked = true; break;
        default: alert("unknown control mode"); break;
      }
    }

    function UpdateTemperatureRef(aTemperatureRef) {
      mTemperatureRef.value = aTemperatureRef;
    }

    function UpdateHysteresis(aHysteresis) {
      mHysteresis.value = aHysteresis;
    }

    function UpdateOutputAnalog(aOutputAnalog) {
      mOutputAnalog.checked = aOutputAnalog;
    }

    function UpdateOutput(aOutput) {
      mOutputValue.innerHTML = Math.round(100.0 * aOutput) + '%';
      mOutputRange.value = aOutput;
    }

    function UpdateStatusLED(aStatusLED) {
      mStatusLED.innerHTML = aStatusLED;
    }

    function UpdateKey(aKey) {
      mKey.innerHTML = aKey;
    }

  </script>
</head>

<body onload='javascript:initAll()'>
  <div style='text-align:left;display:inline-block;min-width:340px'>
  <table border='0' width='100%' class='selectnone' style='border-spacing: 10px 3px;'>
    
    <tr>
      <td colspan='2'>
        <br>
        <input id='mName' type='text' value='(na)' style='width:100%' class='r' maxlength='30'>
      </td>
    </tr>
    
    <tr><td colspan='2'></td></tr>

    <tr>
      <td style='text-align:right'>Pressure</td>
      <td style='text-align:left' id='mPressure'>(na)</td>
    </tr>

    <tr>
      <td style='text-align:right'>Temperature</td>
      <td style='text-align:left' id='mTemperature'>(na)</td>
    </tr>

    <tr>
      <td style='text-align:right'>Humidity</td>
      <td style='text-align:left' id='mHumidity'>(na)</td>
    </tr>

    <tr><td colspan='2'><hr noshade></td></tr>

    <tr>
      <td style='text-align:right' valign='top'>Output Control</td>
      <td style='text-align:left'><table border='0' style='border-collapse:collapse'>
        <tr><td><input id='mControlModeOff' type='radio' name='control' style='margin-top:0px'></td><td><label for='mControlModeOff'> Off<label></td></tr>
        <tr><td><input id='mControlModeOnBelow' type='radio' name='control' style='margin-top:0px'></td><td><label for='mControlModeOnBelow'> On, if below ref (heater)</label></td></tr>
        <tr><td><input id='mControlModeOnAbove' type='radio' name='control' style='margin-top:0px'></td><td><label for='mControlModeOnAbove'> On, if above ref (cooler)</label></td></tr>
        <tr><td><input id='mControlModeOn' type='radio' name='control' style='margin-top:0px'></td><td><label for='mControlModeOn'> On</label></td></tr>
      </table></td>
    </tr>

    <tr>
      <td style='text-align:right'>Temperature Ref</td>
      <td style='text-align:left'><input id='mTemperatureRef' type='number' min='-100' max='100' step='0.1' value='0' style='width:80px;margin-left:4px'> °C</td>
    </tr>

    <tr>
      <td style='text-align:right'>Hysteresis</td>
      <td style='text-align:left'><input id='mHysteresis' type='number' min='0' max='100' step='0.1' value='0' style='width:80px;margin-left:4px'> °C</td>
    </tr>

    <tr>
      <td style='text-align:right'>Analog Out</td>
      <td style='text-align:left'><input id='mOutputAnalog' type='checkbox'></td>
    </tr>

    <tr>
      <td style='text-align:right'>Output</td>
      <td style='text-align:left' id='mOutput'><table cellpadding='0' cellspacing='0' border='0' style='border-collapse:collapse'><tr>
        <td style='text-align:left'><input id='mOutputRange' type='range' name='outputrange' min='0' max='1' step='0.1' value='0'></td>
        <td>&nbsp;<span id='mOutputValue'>(na)</span></td>
      </tr></table></td>
    </tr>

    <tr>
      <td style='text-align:right'>Status LED</td>
      <td style='text-align:left' id='mStatusLED'>(na)</td>
    </tr>

    <tr>
      <td style='text-align:right'>Key</td>
      <td style='text-align:left' id='mKey'>(na)</td>
    </tr>

    <tr><td colspan='2'><hr noshade></td></tr>
    
    <tr>
      <td colspan='2'>
        Web Socket Status: <span id='mWebSocketStatus'>(na)</span><br>
        Temperature Sensor Status: <span id='mSensorStatus'>(na)</span><br>
        (c) 2020, <a href='ggGoofy.html'>Christoph Laimer</a>
      </td>
    </tr>

  </table>
  </div>
</body>

</html>